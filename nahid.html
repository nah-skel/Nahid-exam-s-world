<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nahid Exam's World - অনলাইন পরীক্ষা</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* বাংলা ফন্ট এবং বেসিক স্টাইল */
        @import url('https://fonts.googleapis.com/css2?family=Tiro+Bangla:wght@400;700&display=swap');
        body {
            font-family: 'Tiro Bangla', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* Custom scrollbar for question section */
        #quiz-section {
            max-height: 70vh;
            overflow-y: auto;
        }
        /* Style for the JSON textarea */
        .json-editor {
            font-family: monospace;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
            min-height: 300px;
        }
    </style>
</head>
<body>

<div id="app-container" class="w-full max-w-lg mx-auto p-4 md:p-8 bg-white shadow-xl rounded-xl">
    
    <!-- Header -->
    <header class="text-center mb-6">
        <h1 class="text-3xl md:text-4xl font-bold text-indigo-700">Nahid Exam's World</h1>
        <p class="text-gray-600 mt-2 text-xl">আপনার অনলাইন পরীক্ষার কেন্দ্র</p>
    </header>

    <!-- Loading State -->
    <div id="loading" class="text-center p-8">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500 mx-auto"></div>
        <p class="mt-4 text-indigo-500">ডাটা লোড হচ্ছে, অনুগ্রহ করে অপেক্ষা করুন...</p>
    </div>

    <!-- Admin Link -->
    <div class="text-right mb-4">
        <button id="toggle-admin-button" class="text-sm text-gray-500 hover:text-indigo-600 focus:outline-none">
            এডমিন লগইন
        </button>
    </div>

    <!-- Login/ID Input Section (Student) -->
    <div id="login-section" class="hidden p-6 bg-indigo-50 border border-indigo-200 rounded-lg shadow-inner">
        <h2 class="text-2xl font-semibold mb-4 text-indigo-800">পরীক্ষায় অংশগ্রহণের জন্য লগইন করুন</h2>
        <p id="user-id-display" class="text-sm text-gray-500 mb-4 break-words">
            বর্তমান ডিভাইস আইডি: <span class="font-mono text-xs text-red-500"></span>
        </p>

        <div class="mb-4">
            <label for="student-id" class="block text-lg font-medium text-gray-700 mb-1">আপনার নাম বা আইডি দিন:</label>
            <input type="text" id="student-id" placeholder="যেমন: নাহিদ-০১"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                   required>
        </div>
        
        <button id="start-exam-button"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md transform hover:scale-[1.01]">
            পরীক্ষা শুরু করুন
        </button>
        
        <p id="login-message" class="mt-4 text-center text-red-600 font-medium hidden"></p>
    </div>

    <!-- Admin Login Section -->
    <div id="admin-login-section" class="hidden p-6 bg-red-50 border border-red-200 rounded-lg shadow-inner">
        <h2 class="text-2xl font-semibold mb-4 text-red-800">এডমিন লগইন</h2>
        <div class="mb-4">
            <label for="admin-password" class="block text-lg font-medium text-gray-700 mb-1">সিক্রেট পাসওয়ার্ড দিন:</label>
            <input type="password" id="admin-password" placeholder="গোপন চাবি"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 text-lg"
                   required>
        </div>
        <button id="admin-login-button"
                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md transform hover:scale-[1.01]">
            লগইন করুন
        </button>
        <p id="admin-login-message" class="mt-4 text-center text-red-600 font-medium hidden">পাসওয়ার্ড ভুল হয়েছে।</p>
    </div>

    <!-- Quiz Section -->
    <div id="quiz-section" class="hidden p-6 border border-green-200 bg-green-50 rounded-lg shadow-md mt-4">
        <h2 class="text-2xl font-bold mb-4 text-green-700">পরীক্ষার প্রশ্নাবলী</h2>
        
        <!-- Questions will be inserted here -->
        <div id="questions-container">
            <!-- Dynamic content -->
        </div>

        <button id="submit-exam-button"
                class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg transform hover:scale-[1.01]">
            পরীক্ষা জমা দিন ও ফলাফল দেখুন
        </button>
    </div>

    <!-- Result Section (Student) -->
    <div id="result-section" class="hidden text-center p-8 bg-yellow-50 border-4 border-yellow-400 rounded-lg shadow-xl mt-4">
        <h2 class="text-3xl font-extrabold text-yellow-800 mb-4">পরীক্ষা শেষ!</h2>
        <p class="text-xl text-gray-700">আপনার আইডি: <span id="result-user-id" class="font-semibold text-indigo-600"></span></p>
        <p class="text-2xl font-bold mt-3">মোট স্কোর:</p>
        <p id="final-score" class="text-6xl font-extrabold text-yellow-600 my-4">--/--</p>
        <p class="text-lg text-gray-600">আপনার ফলাফল সফলভাবে সংরক্ষণ করা হয়েছে।</p>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden mt-4 p-6 bg-gray-100 border border-gray-300 rounded-lg shadow-2xl">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">এডমিন ড্যাশবোর্ড</h2>
        
        <div id="admin-tabs" class="flex mb-4 border-b">
            <button id="tab-questions" class="tab-button text-lg font-semibold px-4 py-2 text-indigo-600 border-b-2 border-indigo-600">প্রশ্ন এডিট করুন</button>
            <button id="tab-results" class="tab-button text-lg font-semibold px-4 py-2 text-gray-500 border-b-2 border-transparent">ফলাফল দেখুন</button>
            <button id="admin-logout-button" class="ml-auto text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-gray-700">লগআউট</button>
        </div>

        <!-- Question Editor Tab Content -->
        <div id="questions-tab-content" class="tab-content">
            <p class="text-sm text-gray-600 mb-3">নিচের JSON ফরমেটে প্রশ্নগুলো এডিট করুন। প্রতিটি প্রশ্নের id ইউনিক হতে হবে।</p>
            <textarea id="question-json-editor" class="json-editor w-full p-3 border border-gray-400 rounded-lg focus:ring-indigo-500" placeholder="JSON প্রশ্নাবলী এখানে"></textarea>
            <button id="save-questions-button"
                    class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg">
                প্রশ্নাবলী সংরক্ষণ করুন
            </button>
            <p id="save-message" class="mt-2 text-center text-sm hidden"></p>
        </div>

        <!-- Results Table Tab Content -->
        <div id="results-tab-content" class="tab-content hidden">
            <h3 class="text-xl font-semibold mb-3">পরীক্ষার ফলাফলসমূহ</h3>
            <div id="results-table-container" class="overflow-x-auto max-h-96">
                <!-- Dynamic results table will be inserted here -->
            </div>
            <button id="refresh-results-button" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
                ফলাফল রিফ্রেশ করুন
            </button>
        </div>
    </div>
    <!-- End Admin Panel -->


    <!-- Modal for messages (replaces alert()) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-3">ত্রুটি</h3>
            <p id="modal-content" class="text-gray-700 mb-4">একটি বার্তা</p>
            <button id="close-modal-button" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">বন্ধ করুন</button>
        </div>
    </div>

</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firebase log level for debugging
    setLogLevel('Debug');

    // --- Configuration and Global Variables ---

    // !!! IMPORTANT: CHANGE THIS PASSWORD TO A STRONG ONE !!!
    const ADMIN_PASSWORD = "nahid_admin_2024"; // আপনার গোপন পাসওয়ার্ড
    
    // Global Variables for Firebase Setup
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let currentUserId = null; // Firebase Auth UID
    let studentIdentifier = null; // User-entered name/ID
    let quizQuestions = []; // Stores dynamically loaded questions
    let isAdmin = false;

    // --- DOM Elements ---
    const loadingEl = document.getElementById('loading');
    const loginSectionEl = document.getElementById('login-section');
    const adminLoginSectionEl = document.getElementById('admin-login-section');
    const quizSectionEl = document.getElementById('quiz-section');
    const resultSectionEl = document.getElementById('result-section');
    const questionsContainerEl = document.getElementById('questions-container');
    const studentIdInput = document.getElementById('student-id');
    const startExamButton = document.getElementById('start-exam-button');
    const submitExamButton = document.getElementById('submit-exam-button');
    const loginMessageEl = document.getElementById('login-message');
    const userIdDisplayEl = document.querySelector('#user-id-display span');
    const toggleAdminButton = document.getElementById('toggle-admin-button');
    const adminPasswordInput = document.getElementById('admin-password');
    const adminLoginButton = document.getElementById('admin-login-button');
    const adminLoginMessageEl = document.getElementById('admin-login-message');
    const adminPanelEl = document.getElementById('admin-panel');
    const questionJsonEditor = document.getElementById('question-json-editor');
    const saveQuestionsButton = document.getElementById('save-questions-button');
    const saveMessageEl = document.getElementById('save-message');
    const resultsTableContainer = document.getElementById('results-table-container');
    const refreshResultsButton = document.getElementById('refresh-results-button');
    const adminLogoutButton = document.getElementById('admin-logout-button');
    
    // Modal Elements
    const messageModal = document.getElementById('message-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    const closeModalButton = document.getElementById('close-modal-button');

    // --- Utility Functions ---

    /**
     * Shows a custom modal message.
     */
    function showModal(title, message, type = 'error') {
        modalTitle.textContent = title;
        modalContent.textContent = message;
        
        modalTitle.className = 'text-xl font-bold mb-3 ' + (type === 'success' ? 'text-green-600' : 'text-red-600');
        messageModal.classList.remove('hidden');
    }

    closeModalButton.addEventListener('click', () => {
        messageModal.classList.add('hidden');
    });

    /**
     * Sanitizes the input string for use as a Firestore Document ID.
     */
    function sanitizeId(id) {
        if (!id || typeof id !== 'string') return 'invalid_id_' + Date.now();
        let cleanId = id.trim().toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-');
        return cleanId.substring(0, 50) || 'default_user_' + Date.now();
    }

    // --- Data Handlers (Firestore) ---

    /**
     * Fetches the quiz configuration (questions) from Firestore.
     */
    async function fetchQuizConfig() {
        if (!db) return [];
        try {
            // Path: /artifacts/{appId}/public/data/quiz_config/current
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'quiz_config', 'current');
            const docSnap = await getDoc(docRef);

            if (docSnap.exists() && docSnap.data().questions) {
                quizQuestions = docSnap.data().questions;
                console.log("Quiz configuration loaded successfully.");
                return quizQuestions;
            } else {
                console.warn("Quiz config not found or empty. Using default data.");
                // Provide initial default data if not found
                const defaultQuestions = [{ id: 1, question: "বাংলাদেশের জাতীয় সংগীতের রচয়িতা কে?", options: ["কাজী নজরুল ইসলাম", "রবীন্দ্রনাথ ঠাকুর", "জীবনানন্দ দাশ", "সুফিয়া কামাল"], correctAnswer: "রবীন্দ্রনাথ ঠাকুর" }];
                await setDoc(docRef, { questions: defaultQuestions });
                quizQuestions = defaultQuestions;
                return quizQuestions;
            }
        } catch (error) {
            console.error("Error fetching quiz config:", error);
            showModal("ডাটা লোড ত্রুটি", "প্রশ্নাবলী লোড করা যায়নি।");
            return [];
        }
    }

    /**
     * Saves new quiz configuration (questions) to Firestore. (Admin Function)
     */
    async function saveQuizConfig(newQuestions) {
        if (!db) {
            showModal("ডাটাবেস ত্রুটি", "ডাটাবেস সংযোগ নেই।");
            return false;
        }
        try {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'quiz_config', 'current');
            await setDoc(docRef, { questions: newQuestions });
            quizQuestions = newQuestions; // Update local state
            console.log("Quiz configuration saved successfully.");
            return true;
        } catch (error) {
            console.error("Error saving quiz config:", error);
            showModal("সংরক্ষণ ত্রুটি", "প্রশ্নাবলী সংরক্ষণ ব্যর্থ হয়েছে।");
            return false;
        }
    }

    /**
     * Fetches all exam results. (Admin Function)
     */
    async function fetchExamResults() {
        if (!db) return [];
        try {
            // Path: /artifacts/{appId}/public/data/exam_attempts
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'exam_attempts');
            const querySnapshot = await getDocs(collectionRef);
            
            const results = [];
            querySnapshot.forEach(doc => {
                results.push(doc.data());
            });

            // Sort by timestamp descending
            results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            console.log("Exam results loaded successfully:", results.length);
            return results;
        } catch (error) {
            console.error("Error fetching exam results:", error);
            showModal("ফলাফল ত্রুটি", "পরীক্ষার ফলাফল লোড করা যায়নি।");
            return [];
        }
    }

    /**
     * Checks if the student has already taken the exam.
     */
    async function checkExamAttempt(id) {
        if (!db) return true;
        
        try {
            // Path: /artifacts/{appId}/public/data/exam_attempts/{sanitizedId}
            const attemptDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'exam_attempts', id);
            const docSnap = await getDoc(attemptDocRef);
            
            return docSnap.exists();
        } catch (error) {
            console.error("Error checking exam attempt:", error);
            showModal("চেকিং ত্রুটি", "পরীক্ষার স্থিতি যাচাই করার সময় ত্রুটি হয়েছে।");
            return true; 
        }
    }

    // --- Rendering Functions ---

    /**
     * Renders the quiz questions to the DOM.
     */
    function renderQuiz() {
        questionsContainerEl.innerHTML = ''; // Clear previous content
        if (quizQuestions.length === 0) {
            questionsContainerEl.innerHTML = '<p class="text-red-500 font-semibold">কোনো প্রশ্ন লোড করা যায়নি। এডমিনকে প্রশ্ন সেট করতে বলুন।</p>';
            submitExamButton.disabled = true;
            return;
        }
        submitExamButton.disabled = false;

        quizQuestions.forEach((q, index) => {
            const questionHtml = `
                <div class="mb-6 p-4 border-b border-gray-200">
                    <p class="text-lg font-semibold text-gray-800 mb-3">${index + 1}. ${q.question}</p>
                    <div class="space-y-2">
                        ${q.options.map((option) => `
                            <label class="flex items-center space-x-3 cursor-pointer p-2 bg-white rounded-lg hover:bg-gray-100 transition duration-150">
                                <input type="radio" name="question-${q.id}" value="${option}" class="text-indigo-600 focus:ring-indigo-500 h-5 w-5">
                                <span class="text-base text-gray-700">${option}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
            questionsContainerEl.insertAdjacentHTML('beforeend', questionHtml);
        });
    }

    /**
     * Renders the results table in the Admin Panel.
     */
    function renderResultsTable(results) {
        if (results.length === 0) {
            resultsTableContainer.innerHTML = '<p class="p-4 text-center text-gray-500">এখনও কোনো পরীক্ষা জমা পড়েনি।</p>';
            return;
        }

        let tableHtml = `
            <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg overflow-hidden">
                <thead class="bg-gray-200 sticky top-0">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">নাম/আইডি</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">স্কোর</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">সময়</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        `;
        
        results.forEach(res => {
            const date = new Date(res.timestamp);
            const formattedTime = date.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit', hour12: true });
            const formattedDate = date.toLocaleDateString('bn-BD');

            tableHtml += `
                <tr class="hover:bg-yellow-50">
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${res.rawInputId || res.studentId}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center font-bold text-indigo-700">${res.score} / ${res.totalQuestions}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500">${formattedDate}<br>${formattedTime}</td>
                </tr>
            `;
        });

        tableHtml += `
                </tbody>
            </table>
        `;
        resultsTableContainer.innerHTML = tableHtml;
    }

    // --- Admin Panel Logic ---

    function showAdminPanel() {
        isAdmin = true;
        loginSectionEl.classList.add('hidden');
        adminLoginSectionEl.classList.add('hidden');
        quizSectionEl.classList.add('hidden');
        resultSectionEl.classList.add('hidden');
        adminPanelEl.classList.remove('hidden');

        // Load questions into editor
        questionJsonEditor.value = JSON.stringify(quizQuestions, null, 2);

        // Switch to the Questions tab by default and fetch results
        document.getElementById('tab-questions').click(); 
    }

    function showStudentLogin() {
        isAdmin = false;
        adminPanelEl.classList.add('hidden');
        adminLoginSectionEl.classList.add('hidden');
        quizSectionEl.classList.add('hidden');
        resultSectionEl.classList.add('hidden');
        loginSectionEl.classList.remove('hidden');
    }

    function switchAdminTab(tabName) {
        // Handle Tab Buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('text-indigo-600', 'border-indigo-600');
            btn.classList.add('text-gray-500', 'border-transparent');
        });
        document.getElementById(tab-${tabName}).classList.add('text-indigo-600', 'border-indigo-600');
        document.getElementById(tab-${tabName}).classList.remove('text-gray-500', 'border-transparent');

        // Handle Tab Content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(${tabName}-tab-content).classList.remove('hidden');

        // Special action for results tab
        if (tabName === 'results') {
            refreshResultsButton.click(); // Automatically refresh results
        }
    }

    // --- Event Listeners ---

    // Toggle Admin Login
    toggleAdminButton.addEventListener('click', () => {
        if (isAdmin) {
            // Already logged in, show student login
            showStudentLogin();
            toggleAdminButton.textContent = 'এডমিন লগইন';
        } else if (loginSectionEl.classList.contains('hidden')) {
            // Student login is hidden, admin login is visible -> switch to student login
            adminLoginSectionEl.classList.add('hidden');
            loginSectionEl.classList.remove('hidden');
            toggleAdminButton.textContent = 'এডমিন লগইন';
        } else {
            // Student login is visible -> switch to admin login
            loginSectionEl.classList.add('hidden');
            adminLoginSectionEl.classList.remove('hidden');
            toggleAdminButton.textContent = 'শিক্ষার্থী লগইন';
        }
    });

    // Admin Login Attempt
    adminLoginButton.addEventListener('click', () => {
        const password = adminPasswordInput.value;
        adminLoginMessageEl.classList.add('hidden');

        if (password === ADMIN_PASSWORD) {
            adminPasswordInput.value = '';
            showAdminPanel();
            toggleAdminButton.textContent = 'শিক্ষার্থী লগইন';
            showModal("লগইন সফল", "স্বাগতম এডমিন, আপনি এখন প্রশ্নাবলী ও ফলাফল পরিচালনা করতে পারবেন।", 'success');
        } else {
            adminLoginMessageEl.textContent = 'পাসওয়ার্ড ভুল হয়েছে।';
            adminLoginMessageEl.classList.remove('hidden');
        }
    });

    // Admin Logout
    adminLogoutButton.addEventListener('click', async () => {
        // Sign out Firebase user just in case, then reset view
        await signOut(auth);
        initializeFirebase(); // Re-authenticate anonymously and reset UID
        showStudentLogin();
        toggleAdminButton.textContent = 'এডমিন লগইন';
        showModal("লগআউট", "আপনি সফলভাবে লগআউট করেছেন।", 'success');
    });

    // Admin Tab Switching
    document.getElementById('tab-questions').addEventListener('click', () => switchAdminTab('questions'));
    document.getElementById('tab-results').addEventListener('click', () => switchAdminTab('results'));


    // Save Questions (Admin)
    saveQuestionsButton.addEventListener('click', async () => {
        saveQuestionsButton.disabled = true;
        saveQuestionsButton.textContent = 'সংরক্ষণ করা হচ্ছে...';
        saveMessageEl.classList.remove('hidden', 'text-green-600', 'text-red-600');
        saveMessageEl.textContent = 'প্রক্রিয়াধীন...';

        try {
            const newQuestions = JSON.parse(questionJsonEditor.value);
            
            // Basic validation check
            if (!Array.isArray(newQuestions) || newQuestions.length === 0 || !newQuestions.every(q => q.id && q.question && Array.isArray(q.options) && q.correctAnswer)) {
                throw new Error("প্রশ্নাবলীর ফরমেট সঠিক নয়। এটি Array of Objects হতে হবে এবং প্রতিটি অবজেক্টে 'id', 'question', 'options', ও 'correctAnswer' থাকতে হবে।");
            }

            const success = await saveQuizConfig(newQuestions);

            if (success) {
                saveMessageEl.textContent = 'প্রশ্নাবলী সফলভাবে সংরক্ষণ করা হয়েছে!';
                saveMessageEl.classList.add('text-green-600');
                showModal("সফল", "প্রশ্নাবলী আপডেটেড হয়েছে। শিক্ষার্থীরা এখন নতুন প্রশ্নে পরীক্ষা দেবে।", 'success');
            } else {
                 saveMessageEl.textContent = 'সংরক্ষণ ব্যর্থ হয়েছে।';
                 saveMessageEl.classList.add('text-red-600');
            }

        } catch (e) {
            saveMessageEl.textContent = ত্রুটি: ${e.message};
            saveMessageEl.classList.add('text-red-600');
            showModal("JSON ত্রুটি", e.message);
        } finally {
            saveQuestionsButton.disabled = false;
            saveQuestionsButton.textContent = 'প্রশ্নাবলী সংরক্ষণ করুন';
        }
    });

    // Refresh Results (Admin)
    refreshResultsButton.addEventListener('click', async () => {
        refreshResultsButton.disabled = true;
        refreshResultsButton.textContent = 'রিফ্রেশ করা হচ্ছে...';
        
        const results = await fetchExamResults();
        renderResultsTable(results);

        refreshResultsButton.disabled = false;
        refreshResultsButton.textContent = 'ফলাফল রিফ্রেশ করুন';
    });

    // Student: Start Exam Button
    startExamButton.addEventListener('click', async () => {
        const rawId = studentIdInput.value;
        if (!rawId.trim()) {
            loginMessageEl.textContent = "অনুগ্রহ করে আপনার নাম বা আইডি দিন।";
            loginMessageEl.classList.remove('hidden');
            return;
        }

        const sanitizedId = sanitizeId(rawId);
        studentIdentifier = sanitizedId;
        loginMessageEl.classList.add('hidden');
        startExamButton.disabled = true;
        startExamButton.textContent = 'যাচাই করা হচ্ছে...';

        const alreadyTaken = await checkExamAttempt(sanitizedId);

        startExamButton.disabled = false;
        startExamButton.textContent = 'পরীক্ষা শুরু করুন';

        if (alreadyTaken) {
            showModal("দুঃখিত!", এই আইডি/নামটি (${rawId}) দিয়ে একবার পরীক্ষা দেওয়া হয়েছে। আপনি একাধিকবার পরীক্ষা দিতে পারবেন না।);
            return;
        }

        // Render Quiz and show section
        renderQuiz();
        loginSectionEl.classList.add('hidden');
        quizSectionEl.classList.remove('hidden');
    });

    // Student: Submit Exam Button
    submitExamButton.addEventListener('click', async () => {
        if (!studentIdentifier || !db) {
            showModal("ত্রুটি", "পরীক্ষার্থীর আইডি বা ডাটাবেস প্রস্তুত নয়। আবার শুরু করুন।");
            return;
        }

        submitExamButton.disabled = true;
        submitExamButton.textContent = 'ফলাফল গণনা ও সংরক্ষণ করা হচ্ছে...';
        
        let score = 0;
        let totalQuestions = quizQuestions.length;
        const answers = {};

        // 1. Calculate Score
        let allAnswered = true;
        quizQuestions.forEach(q => {
            const selectedOption = document.querySelector(input[name="question-${q.id}"]:checked);
            if (selectedOption) {
                const answer = selectedOption.value;
                answers[q.id] = answer;
                if (answer === q.correctAnswer) {
                    score += 1;
                }
            } else {
                allAnswered = false;
            }
        });

        if (!allAnswered) {
            submitExamButton.disabled = false;
            submitExamButton.textContent = 'পরীক্ষা জমা দিন ও ফলাফল দেখুন';
            showModal("সাবধান!", "আপনাকে সকল প্রশ্নের উত্তর দিতে হবে।");
            return;
        }

        // 2. Save Score to Firestore
        try {
            // Firestore path: /artifacts/{appId}/public/data/exam_attempts/{sanitizedId}
            const attemptDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'exam_attempts', studentIdentifier);
            
            const resultData = {
                studentId: studentIdentifier, 
                rawInputId: studentIdInput.value, 
                firebaseUid: currentUserId, 
                score: score,
                totalQuestions: totalQuestions,
                answers: answers, 
                timestamp: new Date().toISOString(),
                taken: true
            };
            
            await setDoc(attemptDocRef, resultData);
            console.log("Exam result saved successfully.");

            // 3. Display Results
            quizSectionEl.classList.add('hidden');
            document.getElementById('result-user-id').textContent = studentIdInput.value;
            document.getElementById('final-score').textContent = ${score} / ${totalQuestions};
            resultSectionEl.classList.remove('hidden');

        } catch (error) {
            console.error("Error saving exam result:", error);
            submitExamButton.disabled = false;
            submitExamButton.textContent = 'পরীক্ষা জমা দিন ও ফলাফল দেখুন';
            showModal("সংরক্ষণের ত্রুটি", "ফলাফল সংরক্ষণ করার সময় একটি ত্রুটি হয়েছে।");
        }
    });


    // --- Firebase and Auth Initialization ---

    /**
     * Initializes Firebase App and Authentication.
     */
    async function initializeFirebase() {
        try {
            if (Object.keys(firebaseConfig).length === 0) {
                 throw new Error("Firebase configuration is missing or empty.");
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Authentication
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // Listen for auth state change to get the final user ID
            onAuthStateChanged(auth, async (user) => {
                loadingEl.classList.add('hidden');
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplayEl.textContent = currentUserId;
                    console.log("Firebase Auth Ready. Current UID:", currentUserId);
                    
                    // Fetch quiz config immediately after auth is ready
                    await fetchQuizConfig();
                    
                    // Show student login section initially
                    showStudentLogin();
                } else {
                    console.error("Authentication failed or user signed out.");
                    showModal("অথেনটিকেশন ত্রুটি", "ফায়ারবেস অথেনটিকেশন ব্যর্থ হয়েছে।");
                }
            });

        } catch (error) {
            console.error("Firebase initialization or authentication failed:", error);
            loadingEl.classList.add('hidden');
            showModal("গুরুত্বপূর্ণ ত্রুটি", "ওয়েবসাইটটি লোড হতে পারেনি। " + error.message);
        }
    }

    // --- Start Application ---
    initializeFirebase();

</script>

</body>
</html>
